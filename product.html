<!DOCTYPE html>
<html style="cursor: url(images/cursor.gif), default">
<head>
<meta name="viewport" content="width=device-width">
<meta charset="utf-8">
<title>STALKERS SHOP - Товар</title>
<meta name="description" content="STALKERS SHOP - Купи лучшие кит-наборы и предметы">
<link rel="icon" href="./images/favicon.ico">
<link rel="stylesheet" href="css/posible_style.css" />
<script src="js/cursor.js"></script>
<script src="js/cart.js"></script>

</head>
<body style="cursor: url(images/cursor.gif), pointer">
<div id="__next" style="background-image:URL(images/fon.jpg);">
	<!-- Корзина -->
	<div style="position:fixed;top:50px;right:50px;z-index:1">
		<div style="width:50px;height:50px;position:relative">
			<a aria-label="Cart" href="/cart.html">
				<svg stroke="white" fill="currentColor" stroke-width="10" viewBox="0 0 576 512" style="margin:10px" height="28px" width="28px" xmlns="http://www.w3.org/2000/svg">
					<path d="M528.12 301.319l47.273-208C578.806 78.301 567.391 64 551.99 64H159.208l-9.166-44.81C147.758 8.021 137.93 0 126.529 0H24C10.745 0 0 10.745 0 24v16c0 13.255 10.745 24 24 24h69.883l70.248 343.435C147.325 417.1 136 435.222 136 456c0 30.928 25.072 56 56 56s56-25.072 56-56c0-15.674-6.447-29.835-16.824-40h209.647C430.447 426.165 424 440.326 424 456c0 30.928 25.072 56 56 56s56-25.072 56-56c0-22.172-12.888-41.332-31.579-50.405l5.517-24.276c3.413-15.018-8.002-29.319-23.403-29.319H218.117l-6.545-32h293.145c11.206 0 20.92-7.754 23.403-18.681z"></path>
				</svg>
			</a>
			<div data-cart-count style="position:absolute;top:-5px;right:5px;background:red;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;display:none">0</div>
		</div>
	</div>

	<!-- Меню -->
	<nav>
		<div style="display:flex;justify-content:center">
			<div style="display:block;margin:50px auto;text-align:center;justify-content:center">
				<div style="display:flex;justify-content:center;max-width:50vw;margin:0 auto">
					<a aria-label="Home" href="index.html">
						<img src="images/logo.png" alt="logo" width="800">
					</a>
				</div><hr>
				<div style="place-content:center;display:flex;flex-wrap:wrap;padding-top:16px">
					<a aria-label="Home" href="index.html">
						<p class="menubotton">Home</p>
					</a><a aria-label="All categories" href="categories.html">
						<p class="menubotton">Categories</p>
					</a><a aria-label="Reviews" href="reviews.html">
						<p class="menubotton">Reviews</p>
					</a><a aria-label="discord" href="https://discord.gg/6g6s-org-793077035810816031">
						<p class="menubotton">Our Discord</p>
					</a>
				</div>
			</div>
		</div>
	</nav>

	<!-- Основной контент -->
	<div style="display:flex;justify-content:center;padding-left:16px;padding-right:16px;padding-bottom:32px">
		<main style="width:100%;max-width:1440px;background-color:rgb(255, 234, 210)	"> 	
			<div id="product-container" style="display:flex;padding-top:48px;flex-wrap:wrap;min-height:400px">
				<p style="color:white;text-align:center;width:100%">Загрузка товара...</p>
			</div>
		</main>
	</div>

	<script>
// Получить параметр из URL
function getUrlParameter(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

// Получить данные товара с сервера
async function fetchProduct(productId) {
	try {
		const res = await fetch('/api/kits');
		if (!res.ok) throw new Error('HTTP ' + res.status);
		const items = await res.json();
		
		// Добавляем ID если нет
		const itemsWithIds = items.map((item, index) => ({
			...item,
			id: item.id || index
		}));
		
		// Ищем товар по ID (может быть число или строка)
		const product = itemsWithIds.find(item => item.id == productId);
		if (!product) throw new Error('Товар не найден');
		
		return product;
	} catch (e) {
		console.error('Ошибка загрузки товара:', e);
		return null;
	}
}

// Увеличить количество
function increase() {
	const value = document.getElementById("quantity").textContent;
	const new_value = parseInt(value) + 1;
	
	if (currentProduct && new_value > currentProduct.quantity) {
		return;
	}
	
	document.getElementById("quantity").textContent = new_value;
}

// Уменьшить количество
function decrease() {
	const value = document.getElementById("quantity").textContent;
	const new_value = parseInt(value) - 1;
	if (new_value < 0) {
		return;
	}
	document.getElementById("quantity").textContent = new_value;
}

// Функция для получения корзины
function getCart() {
    return JSON.parse(localStorage.getItem('cart')) || [];
}

// Функция для сохранения корзины
function saveCart(cart) {
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartBadge();
}

// Обновить значок количества товаров
function updateCartBadge() {
    const cart = getCart();
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const badge = document.querySelector('[data-cart-count]');
    
    if (badge) {
        if (totalItems > 0) {
            badge.textContent = totalItems;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Обновить корзину на основе выбранного количества
function updateCart() {
	const selected_quantity = parseInt(document.getElementById("quantity").textContent);
	let cart = getCart();
	
	// Ищем товар в корзине
	let existingItem = cart.find(item => item.id === currentProduct.id);
	
	if (selected_quantity === 0) {
		// Если количество 0, удаляем товар из корзины
		cart = cart.filter(item => item.id !== currentProduct.id);
	} else {
		// Если товар уже в корзине, обновляем количество
		if (existingItem) {
			existingItem.quantity = selected_quantity;
		} else {
			// Если товара нет, добавляем его
			cart.push({
				id: currentProduct.id,
				name: currentProduct.name,
				price: currentProduct.price,
				quantity: selected_quantity
			});
		}
	}
	
	// Сохраняем обновленную корзину
	saveCart(cart);
	
	// Обновляем текст кнопки
	updateButtonText(selected_quantity);
}

// Обновить текст кнопки
function updateButtonText(quantity) {
	const button = document.querySelector('.hoverBlack');
	if (button) {
		button.querySelector('div').textContent = 'Обновить корзину';
	}
}

// Отрендерить страницу товара
function renderProduct(product) {
	const container = document.getElementById('product-container');
	if (!product) {
		container.innerHTML = '<p style="color:red;width:100%;text-align:center">Товар не найден</p>';
		return;
	}
	
	const imgSrc = (product.photo && typeof product.photo === 'string') ? product.photo : '/images/elytra.png';
	const name = product.name || 'Товар';
	const price = product.price != null ? product.price : 'N/A';
	const category = product.category || 'Other';
	const quantity = product.quantity || 0;
	
	// Получаем текущее количество из корзины если товар там есть
	const cart = getCart();
	const cartItem = cart.find(item => item.id === product.id);
	const currentQuantity = cartItem ? cartItem.quantity : 0;
	
	container.innerHTML = `
		<div class="cate">
			<img loading="lazy" src="${imgSrc}" alt="${name}">
		</div>
		<div class="cate2">
			<h1 style="font-weight:300;font-size:48px;font-family:Eina Light">${name}</h1>
			<h2 style="color:#3264b1;font-size:24px;padding-top:32px;padding-bottom:32px">${price}₽</h2>
			<p style="margin-bottom:24px">${category}</p>
			<p style="margin-bottom:24px;color:#888;font-size:14px">В наличии: ${quantity} шт.</p>
			
			<div style="margin-bottom:24px">
				<div style="display:flex;align-items:center">
					<div style="padding-left:8px;padding-right:8px;font-size:12px">Количество</div>
					<button class="pm" onclick="decrease()">-</button>
					<p id="quantity" contenteditable="true" style="font-size:12px;line-height:16px;width:32px;height:32px;text-align:center;margin:0px;padding-top:8px">${currentQuantity}</p>
					<button class="pm" onclick="increase()">+</button>
				</div>
			</div>
			<button class="hoverBlack" onclick="updateCart()">
				<div>Добавить в корзину</div>
			</button>
		</div>
	`;
}

// Загрузить и отобразить товар
let currentProduct = null;
async function init() {
	const productId = getUrlParameter('id');
	
	if (!productId) {
		document.getElementById('product-container').innerHTML = '<p style="color:red;width:100%;text-align:center">ID товара не указан</p>';
		return;
	}
	
	const product = await fetchProduct(productId);
	currentProduct = product;
	renderProduct(product);
}

// Запустить при загрузке
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', init);
} else {
	init();
}
	</script>
</div>
</body>
</html>